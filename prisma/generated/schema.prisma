generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============
enum TipoCuenta {
  ADMINISTRADOR
  MODERADOR
  DOCENTE
}

enum TipoGenero {
  HOMBRE
  MUJER
}

enum EdicionEstado {
  ESPERA
  ACTIVA
  FINALIZADA
}

enum EstadoPago {
  PENDIENTE
  COMPLETADO
  RECHAZADO
  REEMBOLSADO
}

enum AccionAuditoria {
  CREAR
  ACTUALIZAR
  ESTADO
  ELIMINAR
}

// ============ TABLA DE AUDITORÍA ============
model auditoria {
  id         String                   @id @default(uuid())
  tabla      String
  registroId String?
  accion     AccionAuditoria
  detalles   Json?
  usuarioId  String?
  creadoEn   DateTime                 @default(now())
  usuario    usuariosAdministradores? @relation(fields: [usuarioId], references: [id])

  @@index([tabla])
  @@index([registroId])
  @@index([accion])
  @@index([usuarioId])
  @@index([creadoEn])
}

// ============ TABLA DE CATEGORÍAS ============
model categorias {
  id               String             @id @default(uuid())
  nombre           String             @unique
  descripcion      String?
  creadoEn         DateTime           @default(now())
  actualizadoEn    DateTime           @updatedAt
  categoriasCursos categoriasCursos[]

  @@index([nombre])
}

// ============ USUARIOS PARA ESTUDIANTES ============
model usuariosEstudiantes {
  id            String          @id @default(uuid())
  correo        String          @unique
  contrasena    String
  usuario       String          @unique
  estado        Boolean         @default(true)
  creadoEn      DateTime        @default(now())
  actualizadoEn DateTime        @updatedAt
  avatar        String?
  // Relación uno-a-uno con @unique
  estudiante    estudiantes?    @relation(fields: [estudianteId], references: [id])
  estudianteId  String?         @unique
  registrado    Boolean         @default(false)
  reviews       reviewsCursos[]
  compras       compras[]

  @@index([correo])
  @@index([estado])
}

// ============ TABLA PARA ESTUDIANTES ============
model estudiantes {
  id              String               @id @default(uuid())
  apellido        String?
  celular         String?
  pais            String?
  genero          TipoGenero?
  fechaNacimiento DateTime?
  nombre          String
  creadoEn        DateTime             @default(now())
  actualizadoEn   DateTime             @updatedAt
  usuario         usuariosEstudiantes?
  calificaciones  calificaciones[]
  certificados    certificados[]
  inscripciones   inscripciones[]

  @@index([nombre, apellido])
}

// ============ USUARIOS PARA ADMIN/DOCENTE ============
model usuariosAdministradores {
  id            String        @id @default(uuid())
  correo        String        @unique
  contrasena    String
  encargado     String?
  estado        Boolean       @default(true)
  creadoEn      DateTime      @default(now())
  actualizadoEn DateTime      @updatedAt
  docente       docente?
  tipo          TipoCuenta
  auditorias    auditoria[]
  grabaciones   grabaciones[]

  @@index([correo])
  @@index([estado])
}

// ============ TABLA PARA DOCENTES ============
model docente {
  id              String                  @id @default(uuid())
  nombre_completo String
  celular         String?
  especialidad    String
  experiencia     Int                     @default(0)
  creadoEn        DateTime                @default(now())
  actualizadoEn   DateTime                @updatedAt
  usuario         usuariosAdministradores @relation(fields: [usuarioId], references: [id])
  usuarioId       String                  @unique
  ediciones       edicionesCursos[]

  @@index([especialidad])
}

// ============ MODELOS DE CURSOS ============
model cursos {
  id               String   @id @default(uuid())
  descripcion      String
  titulo           String
  urlMiniatura     String?
  creadoEn         DateTime @default(now())
  actualizadoEn    DateTime @updatedAt
  descripcionCorta String?
  enVivo           Boolean  @default(false)
  urlCurso         String?

  // Relaciones de contenido (terminan en Cursos)
  ediciones  edicionesCursos[]
  beneficios beneficiosCursos[]
  objetivos  objetivosCursos[]
  requisitos requisitosCursos[]
  categorias categoriasCursos[]
  reviews    reviewsCursos[]

  @@index([titulo])
}

// Relación muchos-a-muchos entre cursos y categorías
model categoriasCursos {
  id          String     @id @default(uuid())
  categoriaId String
  cursoId     String
  categoria   categorias @relation(fields: [categoriaId], references: [id], onDelete: Cascade)
  curso       cursos     @relation(fields: [cursoId], references: [id], onDelete: Cascade)

  @@unique([cursoId, categoriaId])
  @@index([categoriaId])
  @@index([cursoId])
}

// ============ REVIEWS DE CURSOS ============
model reviewsCursos {
  id                    String               @id @default(uuid())
  cursoId               String
  rating                Int
  comentario            String?
  creadoEn              DateTime             @default(now())
  actualizadoEn         DateTime             @updatedAt
  curso                 cursos               @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  usuario               usuariosEstudiantes? @relation(fields: [usuariosEstudiantesId], references: [id])
  usuariosEstudiantesId String?

  @@unique([cursoId])
  @@index([cursoId])
  @@index([rating])
  @@index([creadoEn])
}

// ============ EDICIONES DE CURSOS ============
model edicionesCursos {
  id            String        @id @default(uuid())
  codigo        String // Ej: "MAR-2025", "DIC-2025"
  cursoId       String
  descripcion   String?
  estado        EdicionEstado @default(ESPERA)
  fechaFin      DateTime
  fechaInicio   DateTime
  notaMaxima    Float         @default(100.0)
  notaMinima    Float         @default(51.0)
  urlWhatsapp   String?
  vigente       Boolean       @default(false)
  creadoEn      DateTime      @default(now())
  actualizadoEn DateTime      @updatedAt
  docenteId     String
  docente       docente       @relation(fields: [docenteId], references: [id], onDelete: Cascade)

  // Relaciones
  curso         cursos          @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  compras       compras[]
  certificados  certificados[]
  clases        clases[]
  examenes      examenes[]
  inscripciones inscripciones[]
  precios       preciosCursos[]

  @@unique([cursoId, codigo, docenteId])
  @@index([fechaInicio, fechaFin])
  @@index([estado])
  @@index([codigo])
  @@index([vigente])
}

// ============ MODELOS DE CONTENIDO DE CURSOS ============
model beneficiosCursos {
  id          String   @id @default(uuid())
  cursoId     String
  descripcion String
  orden       Int
  creadoEn    DateTime @default(now())
  curso       cursos   @relation(fields: [cursoId], references: [id], onDelete: Cascade)

  @@index([cursoId, orden])
}

model objetivosCursos {
  id          String   @id @default(uuid())
  cursoId     String
  descripcion String
  orden       Int
  creadoEn    DateTime @default(now())
  curso       cursos   @relation(fields: [cursoId], references: [id], onDelete: Cascade)

  @@index([cursoId, orden])
}

model requisitosCursos {
  id          String   @id @default(uuid())
  cursoId     String
  descripcion String
  orden       Int
  creadoEn    DateTime @default(now())
  curso       cursos   @relation(fields: [cursoId], references: [id], onDelete: Cascade)

  @@index([cursoId, orden])
}

// ============ CLASES Y MATERIALES ============
model clases {
  id          String          @id @default(uuid())
  edicionId   String
  descripcion String
  duracion    Int?
  fecha       DateTime
  orden       Int
  titulo      String
  urlYoutube  String?
  creadoEn    DateTime        @default(now())
  edicion     edicionesCursos @relation(fields: [edicionId], references: [id], onDelete: Cascade)
  materiales  materiales[]
  grabaciones grabaciones[]

  @@index([edicionId, orden])
  @@index([fecha])
}

model materiales {
  id       String   @id @default(uuid())
  claseId  String
  tipo     String
  titulo   String
  url      String
  creadoEn DateTime @default(now())
  clase    clases   @relation(fields: [claseId], references: [id], onDelete: Cascade)

  @@index([claseId])
  @@index([tipo])
}

// ============ EVALUACIÓN ============
model examenes {
  id              String           @id @default(uuid())
  edicionId       String
  descripcion     String?
  fechaDisponible DateTime
  fechaLimite     DateTime
  notaMaxima      Float
  notaMinima      Float
  titulo          String
  creadoEn        DateTime         @default(now())
  edicion         edicionesCursos  @relation(fields: [edicionId], references: [id], onDelete: Cascade)
  calificaciones  calificaciones[]

  @@index([edicionId])
  @@index([fechaDisponible, fechaLimite])
}

model calificaciones {
  id           String      @id @default(uuid())
  aprobado     Boolean
  comentarios  String?
  estudianteId String
  examenId     String
  nota         Float
  creadoEn     DateTime    @default(now())
  estudiante   estudiantes @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  examen       examenes    @relation(fields: [examenId], references: [id], onDelete: Cascade)

  @@unique([estudianteId, examenId])
  @@index([aprobado])
}

// ============ INSCRIPCIÓN ============
model inscripciones {
  id            String          @id @default(uuid())
  edicionId     String
  estado        Boolean         @default(true)
  estudianteId  String
  inscritoEn    DateTime        @default(now())
  actualizadoEn DateTime        @updatedAt
  edicion       edicionesCursos @relation(fields: [edicionId], references: [id], onDelete: Cascade)
  estudiante    estudiantes     @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  compra        compras?        @relation(fields: [compraId], references: [id], onDelete: Cascade)
  compraId      String?         @unique

  @@unique([estudianteId, edicionId])
  @@index([estado])
  @@index([inscritoEn])
}

// ============ CERTIFICACIÓN ============
model certificados {
  id             String          @id @default(uuid())
  codigoUnico    String          @unique
  edicionId      String
  estudianteId   String
  fechaEmision   DateTime
  notaFinal      Float?
  urlCertificado String?
  creadoEn       DateTime        @default(now())
  edicion        edicionesCursos @relation(fields: [edicionId], references: [id], onDelete: Cascade)
  estudiante     estudiantes     @relation(fields: [estudianteId], references: [id], onDelete: Cascade)

  @@unique([estudianteId, edicionId])
}

// ============ PRECIOS DE CURSOS ============
model preciosCursos {
  id                  String          @id @default(uuid())
  edicionId           String
  esDescuento         Boolean         @default(false)
  esPrecioDefault     Boolean         @default(false)
  fechaFin            DateTime?
  fechaInicio         DateTime?
  moneda              String          @default("USD")
  nombre              String
  porcentajeDescuento Float?
  precio              Float
  precioOriginal      Float?
  creadoEn            DateTime        @default(now())
  actualizadoEn       DateTime        @updatedAt
  edicion             edicionesCursos @relation(fields: [edicionId], references: [id], onDelete: Cascade)

  @@index([edicionId, esPrecioDefault])
  @@index([esDescuento])
  @@index([fechaInicio, fechaFin])
}

// ============ COMPRAS ============
model compras {
  id                    String               @id @default(uuid())
  nombre                String
  apellido              String
  edicionId             String
  monto                 Float
  moneda                String               @default("USD")
  providerId            String
  comprobado            Boolean              @default(false)
  fechaCompra           DateTime             @default(now())
  metodo                String?
  // Relaciones
  edicion               edicionesCursos      @relation(fields: [edicionId], references: [id], onDelete: Cascade)
  inscripcion           inscripciones?
  usuariosEstudiantesId String?
  usuario               usuariosEstudiantes? @relation(fields: [usuariosEstudiantesId], references: [id])

  @@index([fechaCompra])
  @@index([comprobado])
}

// ============ GRABACIONES DE CLASES ============
model grabaciones {
  id               String    @id @default(uuid())
  claseId          String
  usuarioId        String // El docente que inició la grabación
  fechaInicio      DateTime  @default(now())
  fechaFin         DateTime?
  duracionSegundos Int? // Duración en segundos (calculado al finalizar)
  completada       Boolean   @default(false)

  // Relaciones
  clase   clases                  @relation(fields: [claseId], references: [id], onDelete: Cascade)
  usuario usuariosAdministradores @relation(fields: [usuarioId], references: [id])

  @@index([claseId])
  @@index([usuarioId])
  @@index([fechaInicio])
  @@index([completada])
}
